## 消息可靠性的保证

可靠性传输机制：

- 持久化存储
- 消息确认机制
- 重试机制
- 幂等性处理

消息的可靠传达：

1. 生产阶段：消息队列通过最常用的请求确认机制，来保证消息的可靠传递
2. 存储阶段（在消息队列中）：持久化存储，高可用部署
3. 消费阶段：消费阶段采用和生产阶段类似的确认机制来保证消息的可靠传递

## 消息的有序性

消息的有序性，需要保证的是整个消息从生产，排队，存储到消费都是有序的

实现方式：

一种方式可以对消息生成不同的消息标识，将统一标识的消息统一推送到同一个队列，并且由一个服务单独消费一个消息队列，然后再分发到对应的业务系统中，这样我们就可以保证消息消费的有序性。

Kafka 从生产者到消费者消费消息这一整个过程其实都是可以保证有序的，导致最终乱序是由于消费者端需要使用多线程并发处理消息来提高吞吐量，比如消费者消费到了消息以后。

在单个`Kafka分`区中，消息的顺序性得到了严格的保证。新产生的消息总是附加到分区日志的末端，消费者按照消息在分区中的物理顺序进行消费。

通过为消息设置Key，Kafka可以确保具有相同Key的消息被路由到同一个分区，这就为实现消息顺序消费提供了基础。

### Kafka原生保证消息顺序消费的实现

**生产者侧**：首先，确保消息按照需要的顺序发送到`Kafka`。若需要全局顺序，所有的消息应被发送到同一个分区。为此，可以通过设置消息键（key）并将所有消息映射到同一个确定的分区上。

**消费者组**：在消费者组层面，确保每个分区仅被组内一个消费者实例消费，这样才能保证该分区内的消息顺序消费。可通过设置消费者组内消费者的并发度为分区数或小于分区数来达到这个目的。

多分区的顺序消费：在多分区场景下，实现全局顺序消费的一种策略是通过定制分区策略，确保具有顺序要求的消息被路由到特定的分区。使用自定义方分区键来实现

## 消息延迟

**Kafka 消息延迟**是指消息从生产者发送到消息被消费者接收之间的时间差。这是一个关键的概念，因为它直接影响到数据流应用程序的实时性和性能。

消息延迟的原因

- **网络延迟**：消息必须通过网络传输到 Kafka 集群，然后再传输到消费者。网络延迟可能会受到网络拓扑、带宽和路由等因素的影响。
- **硬件性能**：Kafka 集群的硬件性能，包括磁盘、内存和 CPU 的速度，会影响消息的写入和读取速度。
- **Kafka 内部处理**：Kafka 集群的内部处理能力也是一个关键因素。消息必须经过分区、日志段和复制等处理步骤，这可能会引入一些处理延迟。



